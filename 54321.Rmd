---
title: "Presentation"
format: html
date: "08/06/2025" 
editor: visual
bibliography: references.bib
csl: "https://www.zotero.org/styles/apa"
---
```{r}
if (!requireNamespace("pacman", quietly = TRUE)) install.packages("pacman")
pacman::p_load(haven, dplyr, tidyr, ggplot2, scales, ggrepel, patchwork)
```

```{r}
df <- haven::read_dta("R data/data/cross_country_data_homicide_migration.dta")
```

```{r}
head(df)
```

 
```{r fig2-top, echo=TRUE, fig.cap="Figure 2 Top: Immigration & Homicides over Time"}
ts <- df %>%
  group_by(year) %>%
  summarise(migr_w = sum(migr_pop * pop1990) / sum(pop1990), hom_w  = sum(homicide_rate * pop1990) / sum(pop1990))
sf <- max(ts$hom_w) / max(ts$migr_w)

p1 <- ggplot(ts, aes(year)) +
  geom_line(aes(y = migr_w),  color="grey40", linewidth=1) +
  geom_point(aes(y = migr_w), color="grey40", shape=21) +
  geom_line(aes(y = hom_w / sf),  color="blue", linewidth=1) +
  geom_point(aes(y = hom_w / sf), color="blue", shape=24) +
  scale_y_continuous(name = "Stock of migrants over population",
    sec.axis = sec_axis(~ . * sf, name = "Homicide rate per 100,000 inhabitants")) +
  scale_x_continuous(breaks = seq(1990, 2020, 5)) +
  theme_minimal() +
  theme(axis.title.x = element_blank())

p1
```
 
```{r fig2-bottom, echo=TRUE, fig.cap="Figure 2 Bottom: Log changes 1990–2019"}
df4 <- df %>%
  filter(year %in% c(1990, 2019)) %>%
  mutate(ln_migr  = log(migr_pop), ln_homic = log(homicide_rate)) %>%
  select(code, year, ln_migr, ln_homic, pop1990) %>%
  pivot_wider(names_from = year, values_from = c(ln_migr, ln_homic),names_sep = "_") %>%
  mutate(dln_migr  = ln_migr_2019  - ln_migr_1990, dln_homic = ln_homic_2019 - ln_homic_1990)

p2 <- ggplot(df4, aes(dln_migr, dln_homic, weight = pop1990)) +
  geom_point(shape=21, fill=NA, color="black") +
  geom_text_repel(aes(label=code), size=3) +
  geom_smooth(method="lm", se=FALSE, color="blue") +
  theme_minimal() +
  labs(x = "log change migration, 1990–2019",y = "log change homicides, 1990–2019")

p2
```
 
 